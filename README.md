# GeoCLIP FastAPI Service

ÐšÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð´Ð»Ñ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑŽ Ð¸ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð¾Ñ…Ð¾Ð¶Ð¸Ñ… Ð¼ÐµÑÑ‚ Ð¿Ð¾Ð±Ð»Ð¸Ð·Ð¾ÑÑ‚Ð¸.

## ðŸŽ¯ Ð¦ÐµÐ»ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚:
- ðŸ” ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð³ÐµÐ¾Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¼ÐµÑÑ‚Ð° Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑŽ (Ð¼Ð¾Ð´ÐµÐ»ÑŒ GeoCLIP).  
- ðŸ“ Ð˜ÑÐºÐ°Ñ‚ÑŒ Ð² Ð±Ð°Ð·Ðµ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð´Ð¾ÑÑ‚Ð¾Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÐµÐ¹ (23+ Ñ‚Ð¾Ñ‡ÐµÐº Ð¿Ð¾ Ð²ÑÐµÐ¼Ñƒ Ð¼Ð¸Ñ€Ñƒ) Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ñ€ÑÐ´Ð¾Ð¼ Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¾Ð¹.  
- ðŸŒ Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ Ð»ÑŽÐ±Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚Ð¾Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ Ñ€Ð°Ð´Ð¸ÑƒÑÑƒ.  
- ðŸ–¥ ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¹ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð½Ð° Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ðµ.

**ÐšÐµÐ¹ÑÑ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**  
- Ð¢ÑƒÑ€Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ñ„Ð¾Ñ‚Ð¾, Â«ÑƒÐ·Ð½Ð°Ð¹, Ð³Ð´Ðµ ÑÑ‚Ð¾Â».  
- Ð–ÑƒÑ€Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¸ Ð±Ð»Ð¾Ð³Ð¸: Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð³ÐµÐ¾-Ð°Ð½Ð½Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹.  
- ÐžÐ±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹: Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ (CLIP + Ð³ÐµÐ¾Ð´Ð°Ð½Ð½Ñ‹Ðµ).  

## ðŸ“¦ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ

Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ ÑÐ´Ñ€Ð° ÑÐµÑ€Ð²Ð¸ÑÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ **GeoCLIP** â€” Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½Ð° Ð±Ð°Ð·Ðµ CLIP, Ð´Ð¾Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½Ð°Ñ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ GPS-ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚ Ð¿Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼ Ð¼ÐµÑÑ‚Ð½Ñ‹Ñ… Ð´Ð¾ÑÑ‚Ð¾Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÐµÐ¹ Ð¸ Ð»Ð°Ð½Ð´ÑˆÐ°Ñ„Ñ‚Ð¾Ð². GeoCLIP Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð½Ð° Ð²Ñ…Ð¾Ð´ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ñ‹Ñ… Ð³ÐµÐ¾ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚ Ñ Ð¾Ñ†ÐµÐ½ÐºÐ°Ð¼Ð¸ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸.

## ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ

```text
.
â”œâ”€â”€ .env                      # Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Postgres ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md                 # Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð²Ñ‹ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚Ðµ)
â”œâ”€â”€ Dockerfile                # Ð¾Ð±Ñ€Ð°Ð· API + frontend
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker
â”‚   â””â”€â”€ db
â”‚       â””â”€â”€ init.sql          # Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð‘Ð” Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ screenshots               # ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
â”‚   â”œâ”€â”€ predict_coords.png
â”‚   â”œâ”€â”€ search_nearby.png
â”‚   â””â”€â”€ examples_nearby.png
â””â”€â”€ app
    â”œâ”€â”€ main.py               # FastAPI-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    â”œâ”€â”€ model.py              # Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° GeoCLIP-Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¸ predict_topk
    â”œâ”€â”€ db.py                 # SQLAlchemy ORM, init_db()
    â”œâ”€â”€ database.py           # Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° (Haversine + Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹)
    â”œâ”€â”€ schemas.py            # Pydantic-Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
    â””â”€â”€ frontend.py           # Streamlit + Folium Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
````

## ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Docker Compose

1. Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ñ„Ð°Ð¹Ð» `.env` Ð¸ Ð·Ð°Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:

   ```dotenv
   POSTGRES_USER=geoclip_user
   POSTGRES_PASSWORD=secret_password
   POSTGRES_DB=geoclip_db
   ```

2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:

   ```bash
   docker-compose up --build -d
   ```

3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ:

   * **API**: [http://localhost:8000](http://localhost:8000)
   * **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)
   * **Frontend (Streamlit)**: [http://localhost:8501](http://localhost:8501)

4. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ:

   ```bash
   docker-compose down --rmi all -v
   ```

## ðŸ“‘ Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ API

### 1. POST `/predict/coords`

* **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹** (query):

  * `top_k` (int, 1â€“10) â€” ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚.
* **Body**: multipart-form `file` (jpg/png).
* **ÐžÑ‚Ð²ÐµÑ‚**:

  ```json
  {
    "predictions": [
      { "lat": 48.8584, "lon": 2.2945, "prob": 0.85 },
      â€¦
    ]
  }
  ```

### 2. POST `/search/nearby`

* **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹** (query):

  * `radius_km` (float, 0.1â€“10000) â€” Ñ€Ð°Ð´Ð¸ÑƒÑ Ð¿Ð¾Ð¸ÑÐºÐ°.
* **Body**: multipart-form `file` (jpg/png).
* **ÐžÑ‚Ð²ÐµÑ‚**:

  ```json
  {
    "center": { "lat": 48.8584, "lon": 2.2945 },
    "matches": [
      {
        "id": "img001",
        "name": "Eiffel Tower",
        "lat": 48.8584,
        "lon": 2.2945,
        "url": "...raw.githubusercontent.com...",
        "distance_km": 0.0
      }, â€¦
    ]
  }
  ```

### 3. GET `/examples/nearby`

* **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹** (query):

  * `lat`  (float, âˆ’90â€“90)
  * `lon`  (float, âˆ’180â€“180)
  * `radius_km` (float, 0.1â€“10000)
* **ÐžÑ‚Ð²ÐµÑ‚**: Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡ÐµÐ½ `/search/nearby`.

### 4. GET `/health`
- **ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ**: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.
- **ÐžÑ‚Ð²ÐµÑ‚**:
  ```json
  {
    "status": "ok"
  }

## ðŸ–¥ Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (Streamlit + Folium)

### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

* **Predict Coords**
  ![Predict Coords](./screenshots/predict_coords.png)

* **Search Nearby**
  ![Search Nearby](./screenshots/search_nearby.png)

* **Examples Nearby**
  ![Examples Nearby](./screenshots/examples_nearby.png)

Ð’ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð²ÐºÐ»Ð°Ð´ÐºÐµ:

* Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð° (Folium) Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°Ð¼Ð¸ Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼Ð¸ hover-tooltip (ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ° + Ñ‚ÐµÐºÑÑ‚),
* Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²,
* ÐŸÑ€ÐµÐ²ÑŒÑŽ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº.

## ðŸ“¦ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸

```txt
torch
geoclip
fastapi
uvicorn[standard]
SQLAlchemy>=1.4
psycopg2-binary
streamlit
folium
streamlit-folium
pandas
requests
Pillow
```
